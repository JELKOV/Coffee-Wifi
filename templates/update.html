<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´í˜ ìˆ˜ì • ìš”ì²­</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <!-- âœ… ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav>
        <div class="logo">
            <a href="/"><h1>â˜• Cafe & Wifi API</h1></a>
        </div>
        <ul class="nav-links">
            <li><a href="/">ğŸ  í™ˆ</a></li>
            <li><a href="/add">â• ì¹´í˜ ì¶”ê°€</a></li>
            <li><a href="/update">âœï¸ ì •ë³´ ìˆ˜ì • ìš”ì²­</a></li>
            <li><a href="/login">ğŸ› ï¸ ê´€ë¦¬ì ë¡œê·¸ì¸</a></li>
        </ul>
    </nav>

    <!-- âœ… ì¹´í˜ ìˆ˜ì • ìš”ì²­ í¼ -->
    <section id="update-cafe-section">
        <h2>âœï¸ ì¹´í˜ ìˆ˜ì • ìš”ì²­</h2>
        <p>ì¹´í˜ ì •ë³´ë¥¼ ìˆ˜ì •í•˜ë ¤ë©´ ì•„ë˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</p>

        <!-- âœ… ì¹´í˜ ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
        <label for="cafe-select">ì¹´í˜ ì„ íƒ:</label>
        <select id="cafe-select" required>
            <option value="">ì¹´í˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
        </select>

        <form id="request-update-form">
            <label for="name">ì¹´í˜ ì´ë¦„</label>
            <input type="text" name="name" id="name" placeholder="ìƒˆë¡œìš´ ì´ë¦„">

            <label for="location">ìœ„ì¹˜</label>
            <input type="text" name="location" id="location" placeholder="ìƒˆë¡œìš´ ìœ„ì¹˜">

            <label for="coffee_price">ì»¤í”¼ ê°€ê²©</label>
            <input type="text" name="coffee_price" id="coffee_price" placeholder="ìƒˆë¡œìš´ ì»¤í”¼ ê°€ê²©">

            <label for="seats">ì¢Œì„ ìˆ˜</label>
            <input type="number" name="seats" id="seats" placeholder="ì¢Œì„ ìˆ˜">

            <!-- âœ… ì¶”ê°€ëœ í•„ë“œ: ì§€ë„ URL ë° ì´ë¯¸ì§€ URL -->
            <label for="map_url">ì§€ë„ URL</label>
            <input type="text" name="map_url" id="map_url" placeholder="ìƒˆë¡œìš´ ì§€ë„ URL">

            <label for="img_url">ì´ë¯¸ì§€ URL</label>
            <input type="text" name="img_url" id="img_url" placeholder="ìƒˆë¡œìš´ ì´ë¯¸ì§€ URL">

            <!-- âœ… ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ -->
            <div class="checkbox-group">
                <label><input type="checkbox" name="has_wifi" id="has_wifi"> WiFi ìˆìŒ</label>
                <label><input type="checkbox" name="has_sockets" id="has_sockets"> ì½˜ì„¼íŠ¸ ìˆìŒ</label>
                <label><input type="checkbox" name="has_toilet" id="has_toilet"> í™”ì¥ì‹¤ ìˆìŒ</label>
                <label><input type="checkbox" name="can_take_calls" id="can_take_calls"> í†µí™” ê°€ëŠ¥</label>
            </div>

            <button type="submit">ìˆ˜ì • ìš”ì²­ ì œì¶œ</button>
        </form>
    </section>

    <script>
        // âœ… ì¹´í˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        async function loadCafes() {
            const response = await fetch("/cafes");
            if (!response.ok) return alert("ì¹´í˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

            const cafes = await response.json();
            const cafeSelect = document.getElementById("cafe-select");

            cafes.forEach(cafe => {
                const option = document.createElement("option");
                option.value = cafe.id;
                option.textContent = `${cafe.name} - ${cafe.location}`;
                cafeSelect.appendChild(option);
            });

            // âœ… ì¹´í˜ ì„ íƒ ì‹œ ê¸°ì¡´ ë°ì´í„° ìë™ ì…ë ¥
            cafeSelect.addEventListener("change", async function() {
                const cafeId = this.value;
                if (!cafeId) return;

                const cafeData = cafes.find(cafe => cafe.id == cafeId);
                if (cafeData) {
                    document.getElementById("name").value = cafeData.name;
                    document.getElementById("location").value = cafeData.location;
                    document.getElementById("coffee_price").value = cafeData.coffee_price || "";
                    document.getElementById("seats").value = cafeData.seats || "";
                    document.getElementById("map_url").value = cafeData.map_url || "";
                    document.getElementById("img_url").value = cafeData.img_url || "";

                    // âœ… ì²´í¬ë°•ìŠ¤ ìë™ ì„¤ì •
                    document.getElementById("has_wifi").checked = cafeData.amenities.has_wifi;
                    document.getElementById("has_sockets").checked = cafeData.amenities.has_sockets;
                    document.getElementById("has_toilet").checked = cafeData.amenities.has_toilet;
                    document.getElementById("can_take_calls").checked = cafeData.amenities.can_take_calls;
                }
            });
        }

        // âœ… ìˆ˜ì • ìš”ì²­ ì œì¶œ
        document.getElementById("request-update-form").onsubmit = async function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            const cafeId = document.getElementById("cafe-select").value;
            if (!cafeId) return alert("ì¹´í˜ë¥¼ ì„ íƒí•˜ì„¸ìš”!");

            // ì²´í¬ë°•ìŠ¤ ê°’ ì²˜ë¦¬
            data.has_wifi = document.getElementById("has_wifi").checked;
            data.has_sockets = document.getElementById("has_sockets").checked;
            data.has_toilet = document.getElementById("has_toilet").checked;
            data.can_take_calls = document.getElementById("can_take_calls").checked;

            const response = await fetch(`/cafes/${cafeId}/update-request`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert("ì¹´í˜ ìˆ˜ì • ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ë°˜ì˜ë©ë‹ˆë‹¤.");
                window.location.href = "/"; // í™ˆìœ¼ë¡œ ì´ë™
            } else {
                alert("ìš”ì²­ ì‹¤íŒ¨: " + (await response.json()).error);
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = loadCafes;
    </script>

</body>
</html>
