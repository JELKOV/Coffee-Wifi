<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ì¹´í˜ ìˆ˜ì • ìš”ì²­</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    <!-- âœ… ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <nav>
        <div class="logo">
            <a href="/"><h1>â˜• Cafe & Wifi API</h1></a>
        </div>
        <ul class="nav-links">
            <li><a href="/">í™ˆ</a></li>
            <li><a href="/admin/cafes/delete">ì¹´í˜ ê´€ë¦¬</a></li>
        </ul>
    </nav>

    <!-- âœ… ê´€ë¦¬ì í˜ì´ì§€ ì œëª© -->
    <h2 class="admin-title">ê´€ë¦¬ì í˜ì´ì§€ - ì¹´í˜ ìˆ˜ì • ìš”ì²­ ëª©ë¡</h2>

    <!-- âœ… ê´€ë¦¬ì í…Œì´ë¸” -->
    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ì¹´í˜ ID</th>
                    <th>ìš”ì²­ ë‚´ìš©</th>
                    <th>ìƒíƒœ</th>
                    <th>ìŠ¹ì¸</th>
                    <th>ê±°ë¶€</th>
                    <th>ì‚­ì œ</th>
                </tr>
            </thead>
            <tbody id="requests-table-body"></tbody>
        </table>
    </div>

    <script>
        async function loadUpdateRequests() {
            const response = await fetch("/admin/update-requests", {
                method: "GET",
                credentials: "include"
            });

            if (response.status === 403) {
                alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
                window.location.href = "/login";  // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                return;
            }

            const requests = await response.json();
            const tbody = document.getElementById("requests-table-body");
            tbody.innerHTML = ""; // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”

            // âœ… ìƒíƒœê°€ "pending"ì¸ ìš”ì²­ë§Œ í‘œì‹œ
            const pendingRequests = requests.filter(req => req.status === "pending");

            pendingRequests.forEach(req => {
                const updatedFields = [];

                if (req.proposed_name && req.original_name !== req.proposed_name) {
                    updatedFields.push(`ğŸ“ <b>ì´ë¦„ ë³€ê²½:</b> ${req.original_name} â†’ <b>${req.proposed_name}</b>`);
                }
                if (req.proposed_location && req.original_location !== req.proposed_location) {
                    updatedFields.push(`ğŸ“ <b>ìœ„ì¹˜ ë³€ê²½:</b> ${req.original_location} â†’ <b>${req.proposed_location}</b>`);
                }
                if (req.proposed_coffee_price && req.original_coffee_price !== req.proposed_coffee_price) {
                    updatedFields.push(`â˜• <b>ì»¤í”¼ ê°€ê²© ë³€ê²½:</b> ${req.original_coffee_price} â†’ <b>${req.proposed_coffee_price}</b>`);
                }
                if (req.proposed_seats && req.original_seats !== req.proposed_seats) {
                    updatedFields.push(`ğŸ’º <b>ì¢Œì„ ìˆ˜ ë³€ê²½:</b> ${req.original_seats} â†’ <b>${req.proposed_seats}</b>`);
                }
                if (req.proposed_map_url && req.original_map_url !== req.proposed_map_url) {
                    updatedFields.push(`ğŸ—º <b>ì§€ë„ URL ë³€ê²½ë¨</b>`);
                }
                if (req.proposed_img_url && req.original_img_url !== req.proposed_img_url) {
                    updatedFields.push(`ğŸ–¼ <b>ì´ë¯¸ì§€ ë³€ê²½ë¨</b>`);
                }
                if (req.proposed_has_toilet !== null && req.original_has_toilet !== req.proposed_has_toilet) {
                    updatedFields.push(`ğŸš» <b>í™”ì¥ì‹¤ ì—¬ë¶€:</b> ${req.original_has_toilet ? "ìˆìŒ" : "ì—†ìŒ"} â†’ <b>${req.proposed_has_toilet ? "ìˆìŒ" : "ì—†ìŒ"}</b>`);
                }
                if (req.proposed_has_wifi !== null && req.original_has_wifi !== req.proposed_has_wifi) {
                    updatedFields.push(`ğŸ“¶ <b>WiFi ì—¬ë¶€:</b> ${req.original_has_wifi ? "ìˆìŒ" : "ì—†ìŒ"} â†’ <b>${req.proposed_has_wifi ? "ìˆìŒ" : "ì—†ìŒ"}</b>`);
                }
                if (req.proposed_has_sockets !== null && req.original_has_sockets !== req.proposed_has_sockets) {
                    updatedFields.push(`ğŸ”Œ <b>ì½˜ì„¼íŠ¸ ì—¬ë¶€:</b> ${req.original_has_sockets ? "ìˆìŒ" : "ì—†ìŒ"} â†’ <b>${req.proposed_has_sockets ? "ìˆìŒ" : "ì—†ìŒ"}</b>`);
                }
                if (req.proposed_can_take_calls !== null && req.original_can_take_calls !== req.proposed_can_take_calls) {
                    updatedFields.push(`ğŸ“ <b>í†µí™” ê°€ëŠ¥ ì—¬ë¶€:</b> ${req.original_can_take_calls ? "ê°€ëŠ¥" : "ë¶ˆê°€ëŠ¥"} â†’ <b>${req.proposed_can_take_calls ? "ê°€ëŠ¥" : "ë¶ˆê°€ëŠ¥"}</b>`);
                }

                // ë³€ê²½ ì‚¬í•­ì´ ì—†ìœ¼ë©´ "ë³€ê²½ ì‚¬í•­ ì—†ìŒ" í‘œì‹œ
                const changesDisplay = updatedFields.length > 0 ? updatedFields.join("<br>") : "ë³€ê²½ ì‚¬í•­ ì—†ìŒ";

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${req.cafe_id}</td>
                    <td>${changesDisplay}</td>
                    <td>${req.status}</td>
                    <td><button onclick="approveRequest(${req.request_id})">âœ… ìŠ¹ì¸</button></td>
                    <td><button onclick="rejectRequest(${req.request_id})">âŒ ê±°ë¶€</button></td>
                    <td><button onclick="deleteRequest(${req.request_id})">ğŸ—‘ ì‚­ì œ</button></td>
                `;
                tbody.appendChild(row);
            });
        }


        async function approveRequest(requestId) {
            const response = await fetch(`/admin/update-requests/${requestId}`, {
                method: "PATCH",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "approve" })
            });

            if (response.ok) {
                alert("âœ… ìš”ì²­ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadUpdateRequests();  // ìƒˆë¡œê³ ì¹¨ ì—†ì´ í…Œì´ë¸”ë§Œ ì—…ë°ì´íŠ¸
            } else {
                alert("ìš”ì²­ ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        async function rejectRequest(requestId) {
            const response = await fetch(`/admin/update-requests/${requestId}`, {
                method: "PATCH",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "reject" })
            });

            if (response.ok) {
                alert("âŒ ìš”ì²­ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadUpdateRequests();  // ìƒˆë¡œê³ ì¹¨ ì—†ì´ í…Œì´ë¸”ë§Œ ì—…ë°ì´íŠ¸
            } else {
                alert("ìš”ì²­ ê±°ë¶€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }


        async function deleteRequest(requestId) {

            const confirmDelete = confirm("ì •ë§ë¡œ ì´ ìš”ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (!confirmDelete) return;

            await fetch(`/admin/update-requests/${requestId}`, {
                method: "DELETE",
                credentials: "include",
            });

            location.reload();
        }

        window.onload = loadUpdateRequests;
    </script>
</body>
</html>